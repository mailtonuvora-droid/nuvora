<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PFZVHN4JNG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-PFZVHN4JNG');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Nuvora</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .success-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .success-card {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: #28a745;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }

            to {
                transform: scale(1);
            }
        }

        .checkmark {
            width: 50px;
            height: 50px;
            border: 5px solid white;
            border-radius: 50%;
            position: relative;
        }

        .checkmark:after {
            content: '';
            position: absolute;
            width: 15px;
            height: 30px;
            border: solid white;
            border-width: 0 5px 5px 0;
            top: 5px;
            left: 15px;
            transform: rotate(45deg);
        }
    </style>
</head>

<body>
    <div class="success-container">
        <div class="success-card">
            <div class="success-icon">
                <div class="checkmark"></div>
            </div>
            <h1 class="mb-3">Payment Successful!</h1>
            <p class="text-muted mb-4">Your order has been placed successfully.</p>
            <div id="order-details" class="mb-4">
                <p class="small text-muted">Processing order...</p>
            </div>
            <a href="index.html" class="btn btn-primary btn-lg">Continue Shopping</a>
            <a href="account.html" class="btn btn-outline-secondary btn-lg ms-2">View Orders</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/database.js"></script>
    <script>
        // Get order ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order_id');

        async function processOrderSuccess() {
            try {
                // Check if this is a COD order (completed directly)
                const completedOrderData = sessionStorage.getItem('completed_order');

                if (completedOrderData) {
                    const { orderId: id, total, paymentMethod } = JSON.parse(completedOrderData);

                    // Clear session storage
                    sessionStorage.removeItem('completed_order');

                    // Display order details (For COD if it's ever enabled again, but usually now it will be online)
                    document.getElementById('order-details').innerHTML = `
                        <p class="fw-bold">Order ID: #${id ? id.slice(0, 8) : orderId || 'Processing'}</p>
                        <p class="small text-muted">Payment Status: <strong class="text-warning">Pending (COD)</strong></p>
                        <p class="small text-muted">Total Amount: <strong>₹${total ? total.toFixed(2) : '0.00'}</strong></p>
                        <p class="small text-success mt-3">✓ Order confirmed! Pay when you receive your items.</p>
                    `;
                } else {
                    // Handle payment gateway orders
                    const pendingOrderData = sessionStorage.getItem('pending_order');

                    if (pendingOrderData) {
                        const { orderId: id, cart, userId } = JSON.parse(pendingOrderData);

                        // Deduct stock (for payment gateway orders)
                        if (cart && window.DB) {
                            console.log('Deducting inventory for', cart.length, 'items');
                            for (const item of cart) {
                                await window.DB.decrementProductStock(item.id, item.quantity);
                            }

                            // Update payment status to 'paid' in DB
                            if (id) {
                                await window.supabaseClient.from('orders').update({ payment_status: 'paid' }).eq('id', id);
                            }
                        }

                        // Clear cart and pending order
                        localStorage.removeItem('nuvora_cart');
                        sessionStorage.removeItem('pending_order');

                        // Display order details
                        document.getElementById('order-details').innerHTML = `
                            <p class="fw-bold">Order ID: #${id ? id.slice(0, 8) : orderId || 'Processing'}</p>
                            <p class="small text-muted">Payment Status: <strong class="text-success">Paid</strong></p>
                            <p class="small text-success mt-3">✓ Payment confirmed! Your order is being processed.</p>
                        `;
                    } else {
                        // Fallback if no session data
                        document.getElementById('order-details').innerHTML = `
                            <p class="fw-bold">Order ID: #${orderId ? orderId.slice(0, 8) : 'Processing'}</p>
                            <p class="small text-muted">Your order has been placed successfully.</p>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error processing order success:', error);
                document.getElementById('order-details').innerHTML = `
                    <p class="text-danger">Error processing order. Please contact support.</p>
                    <p class="small">Order ID: ${orderId || 'Unknown'}</p>
                `;
            }
        }

        // Process on page load
        window.addEventListener('load', processOrderSuccess);
    </script>
</body>

</html>